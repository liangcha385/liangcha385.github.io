---
icon: pen-to-square
date: 2024-07-06
category:
  - Minecraft
tag:
  - 瞎折腾
---

记录对应的解决方案

<!-- more -->

# 一次简单的故障排查

## 发现问题

我和别人开了一个 [mc 服务器](grassblock.cn)，我负责给服务器配置后端转发

自己按照相关文档瞎整一遍发现出问题了

首先是 **连接超时** ，此时认为是我网络问题（因为当时网络环境确实很糟糕），随后我便安装了 [raknetify](https://modrinth.com/plugin/raknetify) 这个插件来改善我与服务器的连接

在我刷二十多分钟手机之后发现一直卡在 **通讯加密中** 这个阶段，我发现问题不止是我网不好这么简单...

## 问题排查

_以前压根没碰到过这种问题，所以只能一步一步来_

紧接着我去问了群友能不能进，得到的答复一样都是卡在 **连接超时** 或者 **通讯加密中**

此时我去后台查看运行记录，发现都是很正常的连接超时

正常连接超时

```log
[15:13:41] [Netty NIO Worker #6/INFO] [multilogin]: [DEBUG] liangcha385's hasJoined verification order: [1], [2]
[15:13:41] [MultiLogin Flows #2/INFO] [multilogin]: [DEBUG] --> GET https://sessionserver.mojang.com/session/minecraft/hasJoined?username=liangcha385&serverId=-6095a39c02b81ddbc5b14ad971b0e1b0841f7b64
[15:13:41] [MultiLogin Flows #2/INFO] [multilogin]: [DEBUG] <-- 200 https://sessionserver.mojang.com/session/minecraft/hasJoined?username=liangcha385&serverId=-6095a39c02b81ddbc5b14ad971b0e1b0841f7b64 (416ms)
[15:13:41] [MultiLogin Flows #2/INFO] [multilogin]: [DEBUG] <-- (1551 bytes)
[15:13:41] [Netty NIO Worker #6/INFO] [multilogin]: liangcha385(uuid: bcd78a03-0c12-4fe0-9f9f-9f8eee971795) from authentication service Official(yid: 1) has been authenticated, profile redirected to liangcha385(uuid: bcd78a03-0c12-4fe0-9f9f-9f8eee971795).
[15:13:41] [Netty NIO Worker #6/INFO] [multilogin]: [DEBUG] Skin restore result of liangcha385 is NO_RESTORER.
[15:14:11] [Netty NIO Worker #6/ERROR] [com.velocitypowered.proxy.connection.MinecraftConnection]: [initial connection] /121.27.240.179:50678: read timed out
[15:14:11] [Netty NIO Worker #6/INFO] [com.velocitypowered.proxy.connection.MinecraftConnection]: [initial connection] /121.27.240.179:50678 has disconnected
```

使用 raknetify 连接失败

```log
[15:16:21] [Netty NIO Worker #12/INFO] [multilogin]: [DEBUG] liangcha385's hasJoined verification order: [1], [2]
[15:16:21] [MultiLogin Flows #3/INFO] [multilogin]: [DEBUG] --> GET https://sessionserver.mojang.com/session/minecraft/hasJoined?username=liangcha385&serverId=628dc776d1ade0828578078507b3ccf5c2b26fbf
[15:16:22] [MultiLogin Flows #3/INFO] [multilogin]: [DEBUG] <-- 200 https://sessionserver.mojang.com/session/minecraft/hasJoined?username=liangcha385&serverId=628dc776d1ade0828578078507b3ccf5c2b26fbf (586ms)
[15:16:22] [MultiLogin Flows #3/INFO] [multilogin]: [DEBUG] <-- (1551 bytes)
[15:16:22] [Netty NIO Worker #12/INFO] [multilogin]: liangcha385(uuid: bcd78a03-0c12-4fe0-9f9f-9f8eee971795) from authentication service Official(yid: 1) has been authenticated, profile redirected to liangcha385(uuid: bcd78a03-0c12-4fe0-9f9f-9f8eee971795).
[15:16:22] [Netty NIO Worker #12/INFO] [multilogin]: [DEBUG] Skin restore result of liangcha385 is NO_RESTORER.
[15:16:22] [Netty NIO Worker #12/INFO] [raknetify]: Preventing vanilla compression as streaming compression is enabled
[15:16:22] [Netty NIO Worker #12/INFO] [raknetify]: Preventing vanilla compression as streaming compression is enabled
[15:21:46] [Netty NIO Worker #12/INFO] [com.velocitypowered.proxy.connection.MinecraftConnection]: [initial connection] /121.27.240.179:50780 has disconnected
```

_另外 raknetify 貌似没设置超时时间，导致我的账号是撑的最久的一个_

无论我的客户端版本是否符合要求，一直都处于 **通讯加密中** 阶段，换回 1.21 客户端也是如此

我认为是插件问题，于是我使用二分法排查插件故障

测试使用客户端 1.21-Fabric0.15.11 与 1.20.6-Fabric0.15.11

首先是插件全部卸载，包括转发端（Velocity）与后端服务器（Leaf 1.21），测试结果全部按预期执行

附预期行为截图

![Minecraft_ 1.20.6](https://img.picui.cn/free/2024/07/06/6688f31f6ab1d.png) ![Minecraft_ 1.21](https://img.picui.cn/free/2024/07/06/6688f31fdeb1d.png)

既然在无修改前提下没有问题，那基本可以断定是某一个插件造成的问题

异常顺利的是我一下子就找到问题插件了，是 [SignedVelocity](https://modrinth.com/plugin/signedvelocity) 和 它的前置 [PacketEvents](https://modrinth.com/plugin/packetevents) 的问题

但是我并不打算一刀切，于是我打算尝试再次使用二分法查出来是哪个插件在作妖

## 问题修复

由于 SignedVelocity 与 PacketEvents 之间存在依赖关系，需要计划好如何在它们不会无法加载的情况下排除

我的计划是

1. 首先安装 PacketEvents 插件，若运行正常就是 SignedVelocity 的问题，若运行失败就是自身问题
2. 如果 PacketEvents 运行失败，更换为 SignedVelocity 的另一个前置 [VPacketEvents](https://modrinth.com/plugin/vPacketEvents) 后令其单独运行，若运行失败则 SignedVelocity 无法使用
3. 若 VPacketEvents 运行成功，加上 SignedVelocity 后再次运行，若运行失败则 SignedVelocity 无法使用

说干就干，毕竟这可影响到服务器是否能正常游玩

不出意外，在第一步时 PacketEvents 插件便出现问题无法使用，那我们只能接着往下执行

![Minecraft_ 1.21 2024_7_6 16_01_06.png](https://img.picui.cn/free/2024/07/06/6688f953d8d95.png)

最后，在各项排查之后发现是 PacketEvents 插件问题，呼又是无聊排错的一天...
